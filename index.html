<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Payge's Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Payge's Blog">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Payge's Blog">
<meta name="twitter:description">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> Payge's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta custom-logo">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Payge's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/24/MessagePack and Protocol Buffers/" itemprop="url">
                  MessagePack and Protocol buffers
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-24T15:30:11+08:00" content="2016-07-24">
              2016-07-24
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-messagepack"><a href="#1-messagepack" class="headerlink" title="1. messagepack"></a>1. messagepack</h2><p>MessagePack is an efficient binary serialization format. It lets you exchange data among multiple languages like JSON. But it’s faster and smaller. Small integers are encoded into a single byte, and typical short strings require only one extra byte in addition to the strings themselves.</p>
<h3 id="messagepack数据类型"><a href="#messagepack数据类型" class="headerlink" title="messagepack数据类型"></a>messagepack数据类型</h3><ul>
<li>Integer represents an integer  </li>
<li>Nil represents nil  </li>
<li>Boolean represents true or false  </li>
<li>Float represents a IEEE 754 double precision floating point number including NaN and Infinity  </li>
<li>Raw  <ul>
<li>String extending Raw type represents a UTF-8 string  </li>
<li>Binary extending Raw type represents a byte array  </li>
</ul>
</li>
<li>Array represents a sequence of objects  </li>
<li>Map represents key-value pairs of objects  </li>
<li>Extension represents a tuple of type information and a byte array where type information is an integer whose meaning is defined by applications  </li>
</ul>
<p>为什么messagepack比json序列化使用的字节流更少， 可通过以下2个对比图有个直观的感觉。</p>
<p>messagepack与json的格式对比1</p>
<p><img src="http://static.open-open.com/lib/uploadImg/20141008/20141008091955_809.png" alt="image"></p>
<p>messagepack与json的格式对比2</p>
<p><img src="http://static.open-open.com/lib/uploadImg/20141008/20141008091956_425.png" alt="image"></p>
<h3 id="messagepack序列化和反序列化"><a href="#messagepack序列化和反序列化" class="headerlink" title="messagepack序列化和反序列化"></a>messagepack序列化和反序列化</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Basic usage example</span><br><span class="line"> *</span><br><span class="line"> * @throws IOException</span><br><span class="line"> */</span><br><span class="line">public static void basicUsage() throws IOException</span><br><span class="line">&#123;</span><br><span class="line">    // Serialize with MessagePacker.</span><br><span class="line">    // MessageBufferPacker is an optimized version of MessagePacker for packing data into a byte array</span><br><span class="line">    MessageBufferPacker packer = MessagePack.newDefaultBufferPacker();</span><br><span class="line">    packer</span><br><span class="line">            .packInt(1)</span><br><span class="line">            .packString(&quot;leo&quot;)</span><br><span class="line">            .packArrayHeader(2)</span><br><span class="line">            .packString(&quot;xxx-xxxx&quot;)</span><br><span class="line">            .packString(&quot;yyy-yyyy&quot;);</span><br><span class="line">            </span><br><span class="line">    // [Advanced] write a raw UTF-8 string</span><br><span class="line">    byte[] s = &quot;utf-8 strings&quot;.getBytes(MessagePack.UTF8);</span><br><span class="line">    packer.packRawStringHeader(s.length);</span><br><span class="line">    packer.writePayload(s);</span><br><span class="line"></span><br><span class="line">    // pack arrays</span><br><span class="line">    int[] arr = new int[] &#123;3, 5, 1, 0, -1, 255&#125;;</span><br><span class="line">    packer.packArrayHeader(arr.length);</span><br><span class="line">    for (int v : arr) &#123;</span><br><span class="line">        packer.packInt(v);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // pack map (key -&gt; value) elements</span><br><span class="line">    packer.packMapHeader(2); // the number of (key, value) pairs</span><br><span class="line">    // Put &quot;apple&quot; -&gt; 1</span><br><span class="line">    packer.packString(&quot;apple&quot;);</span><br><span class="line">    packer.packInt(1);</span><br><span class="line">    // Put &quot;banana&quot; -&gt; 2</span><br><span class="line">    packer.packString(&quot;banana&quot;);</span><br><span class="line">    packer.packInt(2);</span><br><span class="line"></span><br><span class="line">    // pack binary data</span><br><span class="line">    byte[] ba = new byte[] &#123;1, 2, 3, 4&#125;;</span><br><span class="line">    packer.packBinaryHeader(ba.length);</span><br><span class="line">    packer.writePayload(ba);</span><br><span class="line">    </span><br><span class="line">    packer.close(); // Never forget to close (or flush) the buffer</span><br><span class="line"></span><br><span class="line">    // Deserialize with MessageUnpacker</span><br><span class="line">    MessageUnpacker unpacker = MessagePack.newDefaultUnpacker(packer.toByteArray());</span><br><span class="line">    int id = unpacker.unpackInt();             // 1</span><br><span class="line">    String name = unpacker.unpackString();     // &quot;leo&quot;</span><br><span class="line">    int numPhones = unpacker.unpackArrayHeader();  // 2</span><br><span class="line">    String[] phones = new String[numPhones];</span><br><span class="line">    for (int i = 0; i &lt; numPhones; ++i) &#123;</span><br><span class="line">        phones[i] = unpacker.unpackString();   // phones = &#123;&quot;xxx-xxxx&quot;, &quot;yyy-yyyy&quot;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    while (unpacker.hasNext()) &#123;</span><br><span class="line">        // [Advanced] You can check the detailed data format with getNextFormat()</span><br><span class="line">        // Here is a list of message pack data format: https://github.com/msgpack/msgpack/blob/master/spec.md#overview</span><br><span class="line">        MessageFormat format = unpacker.getNextFormat();</span><br><span class="line"></span><br><span class="line">        // You can also use unpackValue to extract a value of any type</span><br><span class="line">        Value v = unpacker.unpackValue();</span><br><span class="line">        switch (v.getValueType()) &#123;</span><br><span class="line">            case NIL:</span><br><span class="line">                v.isNilValue(); // true</span><br><span class="line">                System.out.println(&quot;read nil&quot;);</span><br><span class="line">                break;</span><br><span class="line">            case BOOLEAN:</span><br><span class="line">                boolean b = v.asBooleanValue().getBoolean();</span><br><span class="line">                System.out.println(&quot;read boolean: &quot; + b);</span><br><span class="line">                break;</span><br><span class="line">            case INTEGER:</span><br><span class="line">                IntegerValue iv = v.asIntegerValue();</span><br><span class="line">                if (iv.isInIntRange()) &#123;</span><br><span class="line">                    int i = iv.toInt();</span><br><span class="line">                    System.out.println(&quot;read int: &quot; + i);</span><br><span class="line">                &#125;</span><br><span class="line">                else if (iv.isInLongRange()) &#123;</span><br><span class="line">                    long l = iv.toLong();</span><br><span class="line">                    System.out.println(&quot;read long: &quot; + l);</span><br><span class="line">                &#125;</span><br><span class="line">                else &#123;</span><br><span class="line">                    BigInteger i = iv.toBigInteger();</span><br><span class="line">                    System.out.println(&quot;read long: &quot; + i);</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">            case FLOAT:</span><br><span class="line">                FloatValue fv = v.asFloatValue();</span><br><span class="line">                float f = fv.toFloat();   // use as float</span><br><span class="line">                double d = fv.toDouble(); // use as double</span><br><span class="line">                System.out.println(&quot;read float: &quot; + d);</span><br><span class="line">                break;</span><br><span class="line">            case STRING:</span><br><span class="line">                String s = v.asStringValue().asString();</span><br><span class="line">                System.out.println(&quot;read string: &quot; + s);</span><br><span class="line">                break;</span><br><span class="line">            case BINARY:</span><br><span class="line">                byte[] mb = v.asBinaryValue().asByteArray();</span><br><span class="line">                System.out.println(&quot;read binary: size=&quot; + mb.length);</span><br><span class="line">                break;</span><br><span class="line">            case ARRAY:</span><br><span class="line">                ArrayValue a = v.asArrayValue();</span><br><span class="line">                for (Value e : a) &#123;</span><br><span class="line">                    System.out.println(&quot;read array element: &quot; + e);</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">            case EXTENSION:</span><br><span class="line">                ExtensionValue ev = v.asExtensionValue();</span><br><span class="line">                byte extType = ev.getType();</span><br><span class="line">                byte[] extValue = ev.getData();</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    unpacker.close();</span><br><span class="line"></span><br><span class="line">    System.out.println(String.format(Locale.getDefault(), &quot;id:%d, name:%s, phone:%s&quot;, id, name, Arrays.toString(phones)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-protocol-buffers"><a href="#2-protocol-buffers" class="headerlink" title="2. protocol buffers"></a>2. protocol buffers</h2><h3 id="scalar-value-types"><a href="#scalar-value-types" class="headerlink" title="scalar value types"></a>scalar value types</h3><p><img src="http://i.imgur.com/Gmpp0RI.png" alt="proto"></p>
<h3 id="protocol-buffers序列化和反序列化"><a href="#protocol-buffers序列化和反序列化" class="headerlink" title="protocol buffers序列化和反序列化"></a>protocol buffers序列化和反序列化</h3><p>步骤：</p>
<p>创建消息的定义文件.proto；</p>
<p>使用protoc工具将proto文件转换为相应语言的源码；</p>
<p>使用类库支持的序列化和反序列化方法进行操作。</p>
<ol>
<li>定义proto文件Person.proto</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">package serialize;</span><br><span class="line">option java_package = &quot;com.payge.proto&quot;;</span><br><span class="line">option java_outer_classname = &quot;PersonProto&quot;;</span><br><span class="line"></span><br><span class="line">message Person &#123;</span><br><span class="line">	required int32 id = 1;</span><br><span class="line">	required string name = 2;</span><br><span class="line">	required string city = 3;</span><br><span class="line">	required string email = 4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>将Person.proto文件转换为java语言的源码</li>
</ol>
<p>执行命令：protoc -I=src –java_out=out src/Person.proto产生Person的java文件。</p>
<h2 id="3-json-msgpack-protobuf-序列化和反序列化比较"><a href="#3-json-msgpack-protobuf-序列化和反序列化比较" class="headerlink" title="3. json, msgpack, protobuf 序列化和反序列化比较"></a>3. json, msgpack, protobuf 序列化和反序列化比较</h2><h3 id="以相同数据分别用这三种方式序列化和反序列化进行测试比较"><a href="#以相同数据分别用这三种方式序列化和反序列化进行测试比较" class="headerlink" title="以相同数据分别用这三种方式序列化和反序列化进行测试比较"></a>以相同数据分别用这三种方式序列化和反序列化进行测试比较</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">public static void json() throws JSONException, UnsupportedEncodingException &#123;</span><br><span class="line">    long s = System.currentTimeMillis();</span><br><span class="line">    JSONArray jsonArray = new JSONArray();</span><br><span class="line">    for (int i = 0; i &lt; 10000; i++) &#123;</span><br><span class="line">        JSONObject json = new JSONObject();</span><br><span class="line">        json.put(&quot;id&quot;, i);</span><br><span class="line">        json.put(&quot;name&quot;, &quot;person&quot; + i);</span><br><span class="line">        json.put(&quot;city&quot;, &quot;city&quot; + i);</span><br><span class="line">        json.put(&quot;email&quot;, &quot;abc@163.com&quot;);</span><br><span class="line">        jsonArray.put(json);</span><br><span class="line">    &#125;</span><br><span class="line">    long e = System.currentTimeMillis();</span><br><span class="line">    System.err.println(&quot;json序列化时间 : &quot; + (e - s));</span><br><span class="line">    System.err.println(&quot;json byte size : &quot; + jsonArray.toString().getBytes(&quot;UTF-8&quot;).length);</span><br><span class="line"></span><br><span class="line">    s = System.currentTimeMillis();</span><br><span class="line">    int len = jsonArray.length();</span><br><span class="line">    for (int i = 0; i &lt; len; i++) &#123;</span><br><span class="line">        JSONObject json = jsonArray.getJSONObject(i);</span><br><span class="line">        json.getInt(&quot;id&quot;);</span><br><span class="line">        json.getString(&quot;name&quot;);</span><br><span class="line">        json.getString(&quot;city&quot;);</span><br><span class="line">        json.getString(&quot;email&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    e = System.currentTimeMillis();</span><br><span class="line">    System.err.println(&quot;json反序列化时间 : &quot; + (e - s));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static void msgPack() throws IOException &#123;</span><br><span class="line">    long s = System.currentTimeMillis();</span><br><span class="line">    MessageBufferPacker packer = MessagePack.newDefaultBufferPacker();</span><br><span class="line">    for (int i = 0; i &lt; 10000; i++) &#123;</span><br><span class="line">        packer</span><br><span class="line">                .packMapHeader(4)</span><br><span class="line">                .packString(&quot;id&quot;)</span><br><span class="line">                .packInt(i)</span><br><span class="line">                .packString(&quot;name&quot;)</span><br><span class="line">                .packString(&quot;person&quot; + i)</span><br><span class="line">                .packString(&quot;city&quot;)</span><br><span class="line">                .packString(&quot;city&quot; + i)</span><br><span class="line">                .packString(&quot;email&quot;)</span><br><span class="line">                .packString(&quot;abc@163.com&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    packer.close();</span><br><span class="line">    long e = System.currentTimeMillis();</span><br><span class="line">    System.err.println(&quot;msg序列化时间 : &quot; + (e - s));</span><br><span class="line">    System.err.println(&quot;msg byte size : &quot; + packer.toByteArray().length);</span><br><span class="line"></span><br><span class="line">    MessageUnpacker unpacker = MessagePack.newDefaultUnpacker(packer.toByteArray());</span><br><span class="line">    s = System.currentTimeMillis();</span><br><span class="line">    while (unpacker.hasNext()) &#123;</span><br><span class="line">        unpacker.getNextFormat();</span><br><span class="line">        Value value = unpacker.unpackValue();</span><br><span class="line">        ValueType type = value.getValueType();</span><br><span class="line">        switch (type) &#123;</span><br><span class="line">            case MAP:</span><br><span class="line">                value.asMapValue();</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    e = System.currentTimeMillis();</span><br><span class="line">    System.err.println(&quot;msg反序列化时间 : &quot; + (e - s));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static void protobuf() throws InvalidProtocolBufferException &#123;</span><br><span class="line">    PersonProto.Person[] persons = new PersonProto.Person[10000];</span><br><span class="line">    long s = System.currentTimeMillis();</span><br><span class="line">    PersonProto.Person.Builder personBuilder;</span><br><span class="line">    for (int i = 0; i &lt; 10000; i++) &#123;</span><br><span class="line">        personBuilder = PersonProto.Person.newBuilder();</span><br><span class="line">        personBuilder.setId(i);</span><br><span class="line">        personBuilder.setName(&quot;person&quot; + i);</span><br><span class="line">        personBuilder.setCity(&quot;city&quot; + i);</span><br><span class="line">        personBuilder.setEmail(&quot;abc@163.com&quot;);</span><br><span class="line">        persons[i] = personBuilder.build();</span><br><span class="line">    &#125;</span><br><span class="line">    long e = System.currentTimeMillis();</span><br><span class="line">    System.err.println(&quot;protobuf 序列化时间 : &quot; + (e - s));</span><br><span class="line"></span><br><span class="line">    List&lt;byte[]&gt; list = new ArrayList&lt;byte[]&gt;(10000);</span><br><span class="line">    long size = 0;</span><br><span class="line">    byte[] bs = null;</span><br><span class="line">    for (int i = 0; i &lt; 10000; i++) &#123;</span><br><span class="line">        bs = persons[i].toByteArray();</span><br><span class="line">        list.add(bs);</span><br><span class="line">        size += bs.length;</span><br><span class="line">    &#125;</span><br><span class="line">    System.err.println(&quot;protobuf byte size : &quot; + size);</span><br><span class="line"></span><br><span class="line">    s = System.currentTimeMillis();</span><br><span class="line">    for (int i = 0; i &lt; list.size(); i++) &#123;</span><br><span class="line">        PersonProto.Person.parseFrom(list.get(i));</span><br><span class="line">    &#125;</span><br><span class="line">    e = System.currentTimeMillis();</span><br><span class="line">    System.err.println(&quot;protobuf 反序列化时间 : &quot; + (e - s));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试数据如下图  </p>
<p><img src="http://i.imgur.com/u91wwhf.png" alt="image"></p>
<hr>
<table>
<thead>
<tr>
<th>序列化类型</th>
<th>字节大小（byte）</th>
<th>序列化时间（ms）</th>
<th>反序列化时间（ms）</th>
</tr>
</thead>
<tbody>
<tr>
<td>json</td>
<td>716671</td>
<td>173</td>
<td>20</td>
</tr>
<tr>
<td>messagepack</td>
<td>547396</td>
<td>887</td>
<td>1567</td>
</tr>
<tr>
<td>protocol buffers</td>
<td>377652</td>
<td>341</td>
<td>276</td>
</tr>
</tbody>
</table>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>从测试对比数据中可以看出，json字节数最大，但是序列化、反序列化性能最高；protocol buffers字节数最小，序列化、反序列化性能居中；messagepack字节数居中，但是序列化、反序列化性能最差。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/14/Mode/" itemprop="url">
                  Using Immersive Full-Screen Mode
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-14T23:27:14+08:00" content="2016-05-14">
              2016-05-14
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Android 4.4 (API Level 19) introduces a new SYSTEM_UI_FLAG_IMMERSIVE flag for <code>setSystemUiVisibility()</code> that lets your app go truly “full screen.” This flag, when combined with the SYSTEM_UI_FLAG_HIDE_NAVIGATION and SYSTEM_UI_FLAG_FULLSCREEN flags, hides the navigation and status bars and lets your app capture all touch events on the screen.</p>
<p>When immersive full-screen mode is enabled, your activity continues to receive all touch events. The user can reveal the system bars with an inward swipe along the region where the system bars normally appear. This clears the SYSTEM_UI_FLAG_HIDE_NAVIGATION flag (and the SYSTEM_UI_FLAG_FULLSCREEN flag, if applied) so the system bars become visible. This also triggers your <code>View.OnSystemUiVisibilityChangeListener</code>, if set. However, if you’d like the system bars to automatically hide again after a few moments, you can instead use the SYSTEM_UI_FLAG_IMMERSIVE_STICKY flag. Note that the “sticky” version of the flag doesn’t trigger any listeners, as system bars temporarily shown in this mode are in a transient state.</p>
<p>Figure 1 illustrates the different “immersive mode” states:</p>
<p>system bars<br>Figure 1. Immersive mode states.</p>
<p>In figure 1:</p>
<ol>
<li><p><strong>Non-immersive mode</strong>—This is how the app appears before it enters immersive mode. It is also how the app appears if you use the IMMERSIVE flag, and the user swipes to display the system bars, thereby clearing the SYSTEM_UI_FLAG_HIDE_NAVIGATION and SYSTEM_UI_FLAG_FULLSCREEN flags. Once these flags are cleared, the system bars reappear and remain visible.<br>Note that it’s best practice to keep all UI controls in sync with the system bars, to minimize the number of states your screen can be in. This provides a more seamless user experience. So here all UI controls are displayed along with the status bars. Once the app enters immersive mode, the UI controls are hidden along with the system bars. To ensure that your UI visibility stays in sync with system bar visibility, make sure to provide an appropriate <code>View.OnSystemUiVisibilityChangeListener</code> to watch for changes, as described in Responding to UI Visibility Changes.</p>
</li>
<li><p><strong>Reminder bubble</strong>—The system displays a reminder bubble the first time users enter immersive mode in your app. The reminder bubble reminds users how to display the system bars.<br>Note: If you want to force the reminder bubble to appear for testing purposes, you can do so by putting the app in immersive mode, turning off the screen with the power button, and then turning the screen back on again within 5 seconds.</p>
</li>
<li><p><strong>Immersive mode</strong>—This is the app in immersive mode, with the system bars and other UI controls hidden. You can achieve this state with either IMMERSIVE or IMMERSIVE_STICKY.<br>Sticky flag—This is the UI you see if you use the IMMERSIVE_STICKY flag, and the user swipes to display the system bars. Semi-transparent bars temporarily appear and then hide again. The act of swiping doesn’t clear any flags, nor does it trigger your system UI visibility change listeners, because the transient appearance of the system bars isn’t considered a UI visibility change.  </p>
</li>
</ol>
<p><strong>Note</strong>: Remember that the “immersive” flags only take effect if you use them in conjunction with<br>SYSTEM_UI_FLAG_HIDE_NAVIGATION, SYSTEM_UI_FLAG_FULLSCREEN, or both. You can just use one or the<br>other, but it’s common to hide both the status and the navigation bar when you’re implementing<br>“full immersion” mode.</p>
<h2 id="Choose-an-Approach"><a href="#Choose-an-Approach" class="headerlink" title="Choose an Approach"></a>Choose an Approach</h2><p>The flags SYSTEM_UI_FLAG_IMMERSIVE and SYSTEM_UI_FLAG_IMMERSIVE_STICKY both provide an immersive experience, but with the differences in behavior described above. Here are examples of when you would use one flag vs. the other:</p>
<p>If you’re building a book reader, news reader, or a magazine, use the IMMERSIVE flag in conjunction with SYSTEM_UI_FLAG_FULLSCREEN and SYSTEM_UI_FLAG_HIDE_NAVIGATION. Because users may want to access the action bar and other UI controls somewhat frequently, but not be bothered with any UI elements while flipping through content, IMMERSIVE is a good option for this use case.<br>If you’re building a truly immersive app, where you expect users to interact near the edges of the screen and you don’t expect them to need frequent access to the system UI, use the IMMERSIVE_STICKY flag in conjunction with SYSTEM_UI_FLAG_FULLSCREEN and SYSTEM_UI_FLAG_HIDE_NAVIGATION. For example, this approach might be suitable for a game or a drawing app.<br>If you’re building a video player or some other app that requires minimal user interaction, you can probably get by with the lean back approach, available since Android 4.0 (API Level 14). For this type of app, simply using SYSTEM_UI_FLAG_FULLSCREEN and SYSTEM_UI_FLAG_HIDE_NAVIGATION should be sufficient. Don’t use the “immersive” flags in this case.<br>Use Non-Sticky Immersion<br>When you use the SYSTEM_UI_FLAG_IMMERSIVE flag, it hides the system bars based on what other UI flags you have set (SYSTEM_UI_FLAG_HIDE_NAVIGATION, SYSTEM_UI_FLAG_FULLSCREEN, or both). When the user swipes inward in a system bars region, the system bars reappear and remain visible.</p>
<p>It’s good practice to include other system UI flags (such as SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION and SYSTEM_UI_FLAG_LAYOUT_STABLE) to keep the content from resizing when the system bars hide and show. You should also make sure that the action bar and other UI controls are hidden at the same time. This snippet demonstrates how to hide and show the status and navigation bars, without resizing the content:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// This snippet hides the system bars.</span><br><span class="line">private void hideSystemUI() &#123;</span><br><span class="line">    // Set the IMMERSIVE flag.</span><br><span class="line">    // Set the content to appear under the system bars so that the content</span><br><span class="line">    // doesn&apos;t resize when the system bars hide and show.</span><br><span class="line">    mDecorView.setSystemUiVisibility(</span><br><span class="line">            View.SYSTEM_UI_FLAG_LAYOUT_STABLE</span><br><span class="line">            | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION</span><br><span class="line">            | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN</span><br><span class="line">            | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION // hide nav bar</span><br><span class="line">            | View.SYSTEM_UI_FLAG_FULLSCREEN // hide status bar</span><br><span class="line">            | View.SYSTEM_UI_FLAG_IMMERSIVE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// This snippet shows the system bars. It does this by removing all the flags</span><br><span class="line">// except for the ones that make the content appear under the system bars.</span><br><span class="line">private void showSystemUI() &#123;</span><br><span class="line">    mDecorView.setSystemUiVisibility(</span><br><span class="line">            View.SYSTEM_UI_FLAG_LAYOUT_STABLE</span><br><span class="line">            | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION</span><br><span class="line">            | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>You may also want to implement the following in conjunction with the IMMERSIVE flag to provide a better user experience:</p>
<p>Register a listener so that your app can get notified of system UI visibility changes, as described in Responding to UI Visibility Changes.<br>Implement <code>onWindowFocusChanged()</code>. If you gain window focus, you may want to re-hide the system bars. If you lose window focus, for example due to a dialog or pop up menu showing above your app, you’ll probably want to cancel any pending “hide” operations you previously scheduled with <code>Handler.postDelayed()</code> or something similar.<br>Implement a <code>GestureDetector</code> that detects <code>onSingleTapUp(MotionEvent)</code>, to allow users to manually toggle the visibility of the system bars by touching your content. Simple click listeners aren’t the best solution for this because they get triggered even if the user drags a finger across the screen (assuming the click target takes up the whole screen).<br>For more discussion of these topics, watch the video <code>DevBytes</code>: Android 4.4 Immersive Mode.</p>
<h2 id="Use-Sticky-Immersion"><a href="#Use-Sticky-Immersion" class="headerlink" title="Use Sticky Immersion"></a>Use Sticky Immersion</h2><p>When you use the SYSTEM_UI_FLAG_IMMERSIVE_STICKY flag, an inward swipe in the system bars areas causes the bars to temporarily appear in a semi-transparent state, but no flags are cleared, and your system UI visibility change listeners are not triggered. The bars automatically hide again after a short delay, or if the user interacts with the middle of the screen.</p>
<p>Figure 2 shows the semi-transparent system bars that briefly appear and then hide again when you use the IMMERSIVE_STICKY flag.</p>
<p>system bars<br>Figure 2. Auto-hiding system bars.</p>
<p>Below is a simple approach to using this flag. Any time the window receives focus, simply set the IMMERSIVE_STICKY flag, along with the other flags discussed in Use IMMERSIVE. For example:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void onWindowFocusChanged(boolean hasFocus) &#123;</span><br><span class="line">        super.onWindowFocusChanged(hasFocus);</span><br><span class="line">    if (hasFocus) &#123;</span><br><span class="line">        decorView.setSystemUiVisibility(</span><br><span class="line">                View.SYSTEM_UI_FLAG_LAYOUT_STABLE</span><br><span class="line">                | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION</span><br><span class="line">                | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN</span><br><span class="line">                | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION</span><br><span class="line">                | View.SYSTEM_UI_FLAG_FULLSCREEN</span><br><span class="line">                | View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY);&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Note: If you like the auto-hiding behavior of IMMERSIVE_STICKY but need to show your own UI controls as well, just use IMMERSIVE combined with <code>Handler.postDelayed()</code> or something similar to re-enter immersive mode after a few seconds.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="payge" />
          <p class="site-author-name" itemprop="name">payge</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">2</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/xiepeijie" target="_blank" title="github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  github
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/payge" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">payge</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  



  
  
  

  

  

</body>
</html>
